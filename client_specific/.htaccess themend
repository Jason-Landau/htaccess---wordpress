# Optimized .htaccess for WordPress on LiteSpeed - TheMend Project
# Updated: 2025-10-22
# Notes:
# - LiteSpeed Cache plugin manages the LSCACHE block automatically.
# - Custom redirects are placed ABOVE WordPress rewrite block.
# - Compression is handled by LiteSpeed (no gzip/deflate rules needed).

# =========================================================
# LiteSpeed Cache (managed by plugin)
# =========================================================
# BEGIN LSCACHE
## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block!  ##
<IfModule LiteSpeed>
RewriteEngine on
CacheLookup on
RewriteRule .* - [E=Cache-Control:no-autoflush]
RewriteRule litespeed/debug/.*\.log$ - [F,L]
RewriteRule \.litespeed_conf\.dat - [F,L]

### marker ASYNC start ###
RewriteCond %{REQUEST_URI} /wp-admin/admin-ajax\.php
RewriteCond %{QUERY_STRING} action=async_litespeed
RewriteRule .* - [E=noabort:1]
### marker ASYNC end ###

### marker MOBILE start ###
RewriteCond %{HTTP_USER_AGENT} Mobile|Android|Silk/|Kindle|BlackBerry|Opera\ Mini|Opera\ Mobi [NC]
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+ismobile]
### marker MOBILE end ###

### marker WEBP start ###
RewriteCond %{HTTP_ACCEPT} image/webp [OR]
RewriteCond %{HTTP_USER_AGENT} iPhone\ OS\ (1[4-9]|[2-9][0-9]) [OR]
RewriteCond %{HTTP_USER_AGENT} Firefox/([6-9][0-9]|[1-9][0-9]{2,})
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+webp]
### marker WEBP end ###

### marker DROPQS start ###
CacheKeyModify -qs:fbclid
CacheKeyModify -qs:gclid
CacheKeyModify -qs:utm*
CacheKeyModify -qs:_ga
### marker DROPQS end ###

</IfModule>
## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block! ##
# END LSCACHE

# =========================================================
# Browser Cache for Static Assets (Non-LiteSpeed Cache)
# =========================================================
# BEGIN NON_LSCACHE
## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block! ##
### marker BROWSER CACHE start ###
<IfModule mod_expires.c>
ExpiresActive on
ExpiresByType application/pdf A31557600
ExpiresByType image/x-icon A31557600
ExpiresByType image/vnd.microsoft.icon A31557600
ExpiresByType image/svg+xml A31557600

ExpiresByType image/jpg A31557600
ExpiresByType image/jpeg A31557600
ExpiresByType image/png A31557600
ExpiresByType image/gif A31557600
ExpiresByType image/webp A31557600
ExpiresByType image/avif A31557600

ExpiresByType video/ogg A31557600
ExpiresByType audio/ogg A31557600
ExpiresByType video/mp4 A31557600
ExpiresByType video/webm A31557600

ExpiresByType text/css A31557600
ExpiresByType text/javascript A31557600
ExpiresByType application/javascript A31557600
ExpiresByType application/x-javascript A31557600

ExpiresByType application/x-font-ttf A31557600
ExpiresByType application/x-font-woff A31557600
ExpiresByType application/font-woff A31557600
ExpiresByType application/font-woff2 A31557600
ExpiresByType application/vnd.ms-fontobject A31557600
ExpiresByType font/ttf A31557600
ExpiresByType font/otf A31557600
ExpiresByType font/woff A31557600
ExpiresByType font/woff2 A31557600

</IfModule>
### marker BROWSER CACHE end ###

## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block! ##
# END NON_LSCACHE

# =========================================================
# Base Security and Proxy Awareness
# =========================================================

# Prevent directory listing
Options -Indexes

# Follow symlinks (common on shared hosts)
Options +SymLinksIfOwnerMatch

# If behind a proxy/CDN (Cloudflare, etc.), ensure HTTPS is detected by WP
<IfModule mod_setenvif.c>
    SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on
</IfModule>

# Deny access to hidden files and version control folders
<IfModule mod_rewrite.c>
RewriteEngine On

# Block access to .git, .svn, and dotfiles (except well-known)
RewriteRule (^|/)\.(?!well-known/).* - [F]

# Protect common sensitive files
RewriteRule ^(composer\.(json|lock)|package\.json|yarn\.lock)$ - [F]
RewriteRule ^(\.env|\.env\..*|wp-config\.php|readme\.html|licen[cs]e\.txt)$ - [F]
</IfModule>

# =========================================================
# Force HTTPS (safe with proxies)
# =========================================================
<IfModule mod_rewrite.c>
RewriteEngine On
# If not HTTPS and not signaled via proxy header, redirect to HTTPS
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# =========================================================
# Custom 301 Redirects - TheMend Project
# (Keep these ABOVE WordPress rewrite block)
# =========================================================
Redirect 301 /could-you-be-in-an-abusive-relationship-and-not-know-it/ https://themendproject.com/abusive-relationship-signs/
Redirect 301 /3-simple-ways-victims-of-abuse-can-care-for-themselves-well-during-quarantine/ https://themendproject.com/how-to-heal-after-an-abusive-relationship/
Redirect 301 /a-reflection-on-2021/ https://themendproject.com/blog/
Redirect 301 /a-season-of-gratitude/ https://themendproject.com/blog/
Redirect 301 /advocating-on-and-off-the-playground-how-to-identify-and-prevent-bullying-in-a-childs-life/ https://themendproject.com/covert-bullying/
Redirect 301 /all-this-abuse-talk-is-just-too-much/ https://themendproject.com/blog/
Redirect 301 /an-introduction-to-parent-child-interaction-therapy-an-effective-tool-to-improve-parent-child-relationships-and-decrease-misbehavior/ https://themendproject.com/blog/
Redirect 301 /annette-and-bucky-the-start-of-educate-equip-restore/ https://themendproject.com/about/
Redirect 301 /can-you-be-too-positive-a-look-at-toxic-positivity/ https://themendproject.com/blog/
Redirect 301 /child-abuse-prevention-month-how-to-spot-maltreatment/ https://themendproject.com/blog/
Redirect 301 /choosing-light/ https://themendproject.com/blog/
Redirect 301 /couples-counseling-part-2-healthy-expectations/ https://themendproject.com/when-is-couples-therapy-not-appropriate/
Redirect 301 /dealing-with-abuse-the-m3nd-project-healing-model-of-compassion-in-action/ https://themendproject.com/how-to-help-abuse-victims/
Redirect 301 /domestic-violence-awareness-month-ending-the-stigma-of-abuse/ https://themendproject.com/blog/
Redirect 301 /domestic-violence/ https://themendproject.com/types-of-abuse/
Redirect 301 /double-abuse-what-is-it-why-do-we-do-it-how-can-we-prevent-it-2/ https://themendproject.com/double-abuse/
Redirect 301 /friends_loving_them_after_the_abuse/ https://themendproject.com/signs-of-an-abusive-relationship/
Redirect 301 /from-victim-to-survivor-something-to-be-thankful-for-this-thanksgiving/ https://themendproject.com/abuse-survivor-stories/
Redirect 301 /give/ https://themendproject.com/join-mend-today/
Redirect 301 /healthy-relationships-when-overcoming-abuse/ https://themendproject.com/how-to-heal-after-an-abusive-relationship/
Redirect 301 /holiday_season/ https://themendproject.com/blog/
Redirect 301 /how-everyday-people-exacerbate-trauma-what-you-need-to-know-about-double-abuse/ https://themendproject.com/double-abuse/
Redirect 301 /how-to-cultivate-lasting-love-in-your-marriage/ https://themendproject.com/find-clarity-and-healing-course/
Redirect 301 /i-want-to-help-someone-being-abused/gain-tools-to-respond-to-abuse-2/ https://themendproject.com/mend-trainings/
Redirect 301 /if-only-rzims-response-to-ravi-zacharias-sex-abuse-allegations/ https://themendproject.com/blog/
Redirect 301 /informational-pdfs/ https://themendproject.com/resources/
Redirect 301 /international-day-of-the-girl-how-to-cultivate-a-strong-sense-of-self-in-young-women/ https://themendproject.com/blog/
Redirect 301 /ipv-in-college/ https://themendproject.com/blog/
Redirect 301 /is-your-partner-spiritually-abusive/ https://themendproject.com/spiritual-abuse/
Redirect 301 /m3nd-beginnings/ https://themendproject.com/about/
Redirect 301 /merry-christmas/ https://themendproject.com/blog/
Redirect 301 /navigating-the-holidays-as-an-abuse-survivor/ https://themendproject.com/blog/
Redirect 301 /our-model/ https://themendproject.com/how-to-help-abuse-victims/
Redirect 301 /parenting-inspiration-to-keep-you-emotionally-healthy/ https://themendproject.com/blog/
Redirect 301 /press-media/ https://themendproject.com/blog/
Redirect 301 /products/ https://themendproject.com/mend-trainings/
Redirect 301 /slider-samples/ https://themendproject.com/
Redirect 301 /stripe-checkout-result/ https://themendproject.com/
Redirect 301 /success-page/ https://themendproject.com/
Redirect 301 /test-before-after-slider/ https://themendproject.com/
Redirect 301 /the-hardest-person-to-forgive/ https://themendproject.com/how-to-heal-after-an-abusive-relationship/
Redirect 301 /the-relationship-between-abuse-and-mental-health/ https://themendproject.com/blog/
Redirect 301 /the-women-who-took-a-stand-a-look-at-domestic-violence-during-womens-history-month/ https://themendproject.com/blog/
Redirect 301 /touch-in-the-workplace/ https://themendproject.com/institutional-abuse/
Redirect 301 /violence_against_women/ https://themendproject.com/blog/
Redirect 301 /walking-with-victims-of-bullying-the-healing-model-of-compassion/ https://themendproject.com/how-to-help-abuse-victims/
Redirect 301 /when-institutions-spiritually-abuse/ https://themendproject.com/spiritual-abuse/

# =========================================================
# WordPress Core Rewrites
# (Leave this block intact; WP updates it on Permalink save)
# =========================================================
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# Don't rewrite existing files or directories
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Route everything else to WP front controller
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# =========================================================
# REST API / admin-ajax: Do NOT Cache
# (Helps with Rank Math "response is not a valid JSON" issues)
# =========================================================
<IfModule mod_headers.c>
    # Flag REST and admin-ajax requests as no-cache
    <FilesMatch "^(.*)$">
        SetEnvIf Request_URI "^/wp-json/.*" IS_WPJSON=1
        SetEnvIf Request_URI "rest_route=" IS_WPJSON=1
        SetEnvIf Request_URI "^/wp-admin/admin-ajax\.php$" IS_AJAX=1
    </FilesMatch>

    Header set Cache-Control "no-cache, no-store, must-revalidate" env=IS_WPJSON
    Header set Pragma "no-cache" env=IS_WPJSON
    Header set Expires "0" env=IS_WPJSON

    Header set Cache-Control "no-cache, no-store, must-revalidate" env=IS_AJAX
    Header set Pragma "no-cache" env=IS_AJAX
    Header set Expires "0" env=IS_AJAX
</IfModule>

# =========================================================
# Security Headers (Basic, Safe Defaults)
# =========================================================
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# =========================================================
# PHP Version Handler (WHM/cPanel EasyApache)
# =========================================================
# php -- BEGIN cPanel-generated handler, do not edit
# Set the "ea-php83" package as the default "PHP" programming language.
<IfModule mime_module>
  AddHandler application/x-httpd-ea-php83 .php .php8 .phtml
</IfModule>
# php -- END cPanel-generated handler, do not edit
