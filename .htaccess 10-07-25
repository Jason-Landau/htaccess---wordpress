# =========================================================
# Base security and proxy awareness
# =========================================================

# Prevent directory listing
Options -Indexes

# Follow symlinks (common on shared hosts)
Options +SymLinksIfOwnerMatch

# If behind a proxy/CDN (Cloudflare, etc.), ensure HTTPS is detected by WP.
<IfModule mod_setenvif.c>
    SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on
</IfModule>

# Deny access to hidden files and version control folders
<IfModule mod_rewrite.c>
RewriteEngine On

# Block access to .git, .svn, and dotfiles (except well-known)
RewriteRule (^|/)\.(?!well-known/).* - [F]

# Protect common sensitive files
RewriteRule ^(composer\.(json|lock)|package\.json|yarn\.lock)$ - [F]
RewriteRule ^(\.env|\.env\..*|wp-config\.php|readme\.html|licen[cs]e\.txt)$ - [F]
</IfModule>

# =========================================================
# OPTIONAL: Canonical Redirects (choose ONE of the below)
# Comment BOTH sections if you don't want domain canonicalization.
# =========================================================

# --- Option A: Force HTTPS (safe with proxies) ---
<IfModule mod_rewrite.c>
RewriteEngine On
# If not HTTPS and not signaled via proxy header, redirect to HTTPS
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# --- Option B1: Force NON-WWW (uncomment to enable) ---
#<IfModule mod_rewrite.c>
#RewriteEngine On
#RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
#RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]
#</IfModule>

# --- Option B2: Force WWW (uncomment to enable) ---
#<IfModule mod_rewrite.c>
#RewriteEngine On
#RewriteCond %{HTTP_HOST} !^www\..+$ [NC]
#RewriteCond %{HTTP_HOST} ^(.+)$ [NC]
#RewriteRule ^ https://www.%1%{REQUEST_URI} [L,R=301]
#</IfModule>

# =========================================================
# WordPress core rewrites
# (Leave this block intact; WP updates it on Permalink save)
# =========================================================
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# Don’t rewrite existing files or directories
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Route everything else to WP front controller
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# =========================================================
# REST API / admin-ajax: do NOT cache; avoid breaking JSON
# (Helps with Rank Math "response is not a valid JSON" issues)
# =========================================================
<IfModule mod_headers.c>
    # Flag REST and admin-ajax requests as no-cache
    <FilesMatch "^(.*)$">
        SetEnvIf Request_URI "^/wp-json/.*" IS_WPJSON=1
        SetEnvIf Request_URI "rest_route=" IS_WPJSON=1
        SetEnvIf Request_URI "^/wp-admin/admin-ajax\.php$" IS_AJAX=1
    </FilesMatch>

    Header set Cache-Control "no-cache, no-store, must-revalidate" env=IS_WPJSON
    Header set Pragma "no-cache" env=IS_WPJSON
    Header set Expires "0" env=IS_WPJSON

    Header set Cache-Control "no-cache, no-store, must-revalidate" env=IS_AJAX
    Header set Pragma "no-cache" env=IS_AJAX
    Header set Expires "0" env=IS_AJAX
</IfModule>

# If you use any maintenance mode or security plugins, ensure they do NOT intercept /wp-json/* or admin-ajax.php

# =========================================================
# CORS for REST (optional, only if your frontend needs it)
# =========================================================
#<IfModule mod_headers.c>
#    <LocationMatch "^/wp-json/">
#        Header always set Access-Control-Allow-Origin "*"
#        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
#        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
#    </LocationMatch>
#</IfModule>

# =========================================================
# Browser caching for static assets (LiteSpeed also helps here)
# =========================================================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
    # Make static assets cacheable and immutable (fingerprinted files recommended)
    <FilesMatch "\.(?:css|js|gif|jpe?g|png|webp|svg|woff2?)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
</IfModule>

# =========================================================
# XML-RPC (optional: block if you don’t use Jetpack/mobile apps)
# =========================================================
#<Files "xmlrpc.php">
#    Order allow,deny
#    Deny from all
#</Files>

# =========================================================
# Optional: Serve WebP if it exists (only if you are NOT using LSCache/Media handling)
# =========================================================
#<IfModule mod_rewrite.c>
#RewriteEngine On
#AddType image/webp .webp
#RewriteCond %{HTTP_ACCEPT} image/webp
#RewriteCond %{REQUEST_FILENAME} (.*)\.(jpe?g|png)$ [NC]
#RewriteCond %1.webp -f
#RewriteRule ^ %1.webp [L]
#</IfModule>

# =========================================================
# MIME and security headers (basic, safe defaults)
# =========================================================
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-XSS-Protection "1; mode=block"
    # If you later add a CSP, do it carefully to not break admin/editor:
    # Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:;"
</IfModule>

# =========================================================
# End of file
# =========================================================
